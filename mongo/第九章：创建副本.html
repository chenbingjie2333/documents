<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="author" content="lcx3114@163.com"/><meta name="created" content="2016-01-16 12:44:45 +0000"/><meta name="updated" content="2016-01-16 15:20:55 +0000"/><title>第九章：创建副本</title></head><body><div><b>建立副本集</b></div><div>mongo --nodb &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;启动shell不连接数据库 </div><div>replicaSet = new ReplSerTest({"nodes" : 3}) &nbsp;&nbsp;&nbsp;&nbsp; 创建一个包含3个服务器的副本集，备份节点默认拒绝读写数据（conn2.setSlaveOk()可读取备份节点数据） </div><div>replicaSet.startSet() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 启动3个mongod进程 </div><div>replicaSet.initiate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 配置复制功能 </div><div>conn1 = new Mongo("localhost:31000") &nbsp;&nbsp; primaryDB = conn1.getDB("test") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 连接到一个数据库副本 </div><div>primaryDB.isMaster() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看副本信息 </div><div>replicaSet.stopSet() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关闭副本集 </div><div><br/></div><div><br/></div><div><b>配置副本集</b></div><div>mongod --replSet spock -f mongod.conf --fork &nbsp;&nbsp;&nbsp;&nbsp; 启动数据库时指定副本标识符为spock </div><div>config = {"_id" : "spock", "members" : [{"_id" : 0, "host" : "server-1:27017"},{"_id" : 0, "host" : "server-2:27017"} ]} &nbsp;&nbsp;&nbsp;&nbsp; 创建副本集配置参数 </div><div>db = (new Mongo("server-1:27017")).getDB("test")</div><div>rs.initiate(config) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;创建副本集，rs是辅助函数，等同于db.adminCommand("replSetInitiate" : config) </div><div><br/></div><div><br/></div><div><b>修改副本集配置</b></div><div>rs.add("server-3:27017") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;追加副本 </div><div>rs.remove("server-3:27017") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 删除副本 </div><div>rs.reconfig(config) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 修改副本集 </div><div>rs.config() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 查看副本集信息 </div><div><br/></div><div><br/></div><div><b>设计副本集</b></div><div>在多数成员内选举出主节点（如5个节点，2个和3个分开，3个中会选举出主节点），最好采用单数副本</div><div><br/></div><div><br/></div><div><b>成员配置选项</b></div><div>rs.addArb("server-5:27017") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在副本集中增加仲裁者（配合大多数选举主节点规则，不保存数据），或config的服务器中加入arbiterOnly:true属性 </div><div><br/></div><div>{"_id" : 0, "host" : "server-1:27017", "priority" : 2} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设置服务器成为主节点的优先集，默认是1，数值越大越优先，0表示不会成为主节点 </div><div><br/></div><div>{"_id" : 0, "host" : "server-1:27017", "priority" : 0, "hidden" : true} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 隐藏副本，只有优先级是0才能隐藏，客户端不会向隐藏副本发送请求，隐藏副本不会作为复制源（其它副本都不可用时，可以成为复制源） </div><div><br/></div><div>slaveDelay设置一个延迟的备份节点（防止人为错误操作，单位是秒），延迟的节点优先级必须是0</div><div><br/></div><div>"buildIndexs":false &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使备份节点不创建索引，节点优先级必须是0，永远不能改回成创建索引 </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>