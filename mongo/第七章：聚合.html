<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="created" content="2016-01-13 09:04:45 +0000"/><meta name="updated" content="2016-01-14 14:19:53 +0000"/><title>第七章：聚合</title></head><body><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div><b>管道操作符</b></div><div>db.blog.aggregate({"$project" : {"author" : 1}},&nbsp;&nbsp;{"$group" : {"_id" : "$author", "count" : {"$sum" : 1}}}, {"$sort" : {"count" : -1}}, {"$limit" : 5}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 管道方法 </div><div><br/></div><div>{"$match" : {"state" : "Oregon"}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 筛选文档，可使用常规查询操作符（$gt等） </div><div><br/></div><div>{"$project" : {"author" : 1}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 投射（将author字段投射出来，0为去掉） </div><div>{"$project" : {"userId" : "$_id"}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将_id重命名取得 </div><div>{"$project" : {"totalPay" : {"$add" : ["$salary", "$bonus"]}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 字段相加；$subtract减、$multiply乘、$divide除、$mod余数 </div><div>{"$project" : {"hiredIn" : {"$month" : "$hireDate"}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;返回月份；$year、$week、$dayOfMonth、$dayOfWeek、$dayOfYear、$hour、$minute、$second </div><div>{"$substr" : [expr, startOffset, numToReturn]} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;截取字符串 </div><div>{"$concat" : [expr1[, expr2...]]} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 连接字符串 </div><div>{"$toLower" : expr} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;字符串转小写 </div><div>{"$toUpper" : expr} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;字符串转大写 </div><div>{"$cmp" : [expr1, expr2]} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比较，返回负数0正数；$strcasecmp对罗马字符组成的字符串比较、$eq/$ne/$gt...比较返回布尔型、 $and并且、$or或者、$not非、$cond三元运算符、$ifNull字段为空返回设定值否则返回字段 </div><div><br/></div><div>{"$group" : {"_id" : "$author", "count" : {"$sum" : 1}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 聚合（按author聚合并计数） </div><div>{"$sum" : "$salary"} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 求和；$avg取平均值、$max最大值、$min最小值、$first第一个值、$last最后一个值 </div><div>$addToSet数组内不存在指定值则插入该值，$push数组内插入指定值</div><div><br/></div><div>{"$unwind" : "$comments"} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;拆分（将数组差分成多个文档） </div><div><br/></div><div>{"$sort" : {"count" : -1}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 排序（按count倒序排序） </div><div><br/></div><div>{"$limit" : 5} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 限制（取得前5条） </div><div>{"$skip" : 5} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;丢弃前5条 </div><div><br/></div><div><br/></div><div><b>MapReduce</b></div><div>使用JavaScript函数查询，速度慢，可分布在多服务器上</div><div>步骤：映射、洗牌、化简、洗牌...</div><div><br/></div><div>map = function() {for (var key in this) {emit(key, {count : 1})}}; &nbsp;&nbsp;&nbsp;&nbsp;得到集合所有的键并计数 </div><div>reduce = function(key, emits) {total = 0; for(var i in emits) {total += emits[i].count;} return {"count" : total}}</div><div>mr = db.runCommand({"mapreduce" : "foo", "map" : map, "reduce" : reduce}) &nbsp;&nbsp;&nbsp;&nbsp; 执行MapReduce </div><div>db[mr.result].find() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看mr返回值 </div><div><br/></div><div>MapReduce命令其它键</div><div>finalize &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将reduce结果发送给这个键 </div><div>keeptemp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true时在连接关闭将临时结果集合保存下来，否则不保存 </div><div>out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 输出集合的名称 </div><div>query &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 发往map前的过滤 </div><div>sort &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发往map前的排序 </div><div>limit &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发往map前的限制 </div><div>scope &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 可以在JavaScript中使用的变量 </div><div>verbose &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 是否记录详细的服务器日志 </div><div><br/></div><div><br/></div><div><b>聚合命令</b></div><div>db.foo.count() &nbsp;&nbsp;&nbsp;&nbsp; 计数 </div><div><br/></div><div>db.runCommand({"distinct" : "users", "key" : "age"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 去重 </div><div><br/></div><div>db.runCommand("group" : {"ns" : "stocks", "key" : "day", "initial" : {"time" : 0}, "$reduce" : function(doc, prev) {if(doc.time > prev.time) {prev.price = doc.price; prev.time = doc.time}}, "condition" : {"day" : {"$gt" : "2010/09/30"}}}) &nbsp;&nbsp;&nbsp;&nbsp; 对集合stocks的day字段聚合，设定time初始值是0，取得一天内时间最大的价格,condition为筛选条件 </div><div>db.blog.group({"key" : {"day" : true}, "initial" : {"tags" : {}}, "$reduce" : function(doc, prev) {...}, "finalize" : function(prev) {...}}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalize在聚合最后执行，可进一步筛选修改 </div><div>db.blog.group({ ... ,"$keyf" : function(x) {return x.category.toLowerCase();}, ... }) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyf对字段先进行处理再分组 </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></body></html>