<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="author" content="lcx3114@163.com"/><meta name="created" content="2016-01-12 14:10:55 +0000"/><meta name="updated" content="2016-01-21 12:08:50 +0000"/><title>第五章：索引</title></head><body><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div><b>索引简介</b></div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建索引；索引有顺序，[-1]为降序；字段必须小于1024字节 </div><div>db.users.ensureIndex({"age" : 1, "username" : 1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 复合索引 </div><div>db.users.ensureIndex({"loc.ip"&nbsp;&nbsp;:&nbsp;&nbsp;1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 嵌套文档上创建索引；直接在loc上创建索引只有当全查询loc时才使用索引 </div><div>db.users.ensureIndex({"comments.0"&nbsp;&nbsp;:&nbsp;&nbsp;1}) &nbsp;&nbsp;&nbsp;&nbsp; 数组上创建索引（多键索引）；直接对数组字段的索引实际上是对数组内每个值进行索引，索引条目比较多；每个索引上只能有一个数组字段，防止出现笛卡尔乘积 </div><div><br/></div><div>$where、{"key" : {"$exists" : true}}等操作不能使用索引；$ne、$not效率较低；当期版本一次查询只能使用一个索引；$or当期版本可能进行两次查询，尽量使用$in</div><div><br/></div><div><br/></div><div><b>使用explain()和hint()</b></div><div>db.users.find().explain() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看执行查询时的系统信息 </div><div>cursor &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 游标类型；BasicCursor（全表扫描）、BtreeCursor（B树索引） </div><div>isMultiKey &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 索引是否为多键索引 </div><div>n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查询返回的文档件数 </div><div>nscanned &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 扫描过的文档数量 </div><div>nscannedObjects &nbsp;&nbsp;&nbsp;&nbsp;使用索引指针去磁盘上查找文档数量 </div><div>scanAndOrder &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 是否在内存中排序 </div><div>indexOnly &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;是否只使用索引就返回全部字段 </div><div>nYields &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查询暂停次数，如有写入请求时查询暂停 </div><div>millis &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 查询耗时毫秒 </div><div>indexBounds &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;描述索引使用情况 </div><div>allPlans &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 尝试过的每个查询计划 </div><div><br/></div><div>db.users.find().hint({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 强制使用指定索引 </div><div>db.users.find().hint({"$natural" : 1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 强制全表扫描 </div><div><br/></div><div><br/></div><div><b>索引类型</b></div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}, {"unique" : true}) &nbsp;&nbsp;&nbsp;&nbsp; 唯一索引；复合键唯一索引单个字段可重复 </div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}, {"unique" : true, "dropDups" : true}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 重复的自动删除 </div><div><br/></div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}, {"sparse" : true}) &nbsp;&nbsp;&nbsp;&nbsp; 稀疏索引，字段不存在或null就不创建索引 </div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1}, {"unique" : true, "sparse" : true}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;多个null不会重复 </div><div><br/></div><div><br/></div><div><b>索引管理</b></div><div>db.users.getIndexes() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 查看集合上的索引 </div><div>db.users.ensureIndex({"username"&nbsp;&nbsp;:&nbsp;&nbsp;1},&nbsp;&nbsp;{"name" : "a"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;标识索引name </div><div>db.users.dropIndex("x_1_y_1") &nbsp;&nbsp;&nbsp;&nbsp; 删除索引 </div><div><br/></div><div>db.foo.ensureIndex({"somefirld" : 1}, {"background" : true}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在后台空闲时建立索引 </div><div>创建索引过大注意不要被Linux的内存溢出杀手（OOM Killer）关闭进程</div><div><br/></div><div><br/></div><div><br/></div></div></body></html>