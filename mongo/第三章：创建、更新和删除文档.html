<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="created" content="2016-01-11 07:08:21 +0000"/><meta name="updated" content="2016-01-12 06:27:37 +0000"/><title>第三章：创建、更新和删除文档</title></head><body><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div><b>插入并保存文档</b></div><div>db.foo.insert({"name" : "aa"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;集合中插入文档 </div><div>db.foo.batchInsert([{"name" : "a"}, {"name" : "b"}]) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;批量插入文档；发生错误时错误前的数据成功，之后的失败，使用continueOnError选项跳过错误继续执行 </div><div><br/></div><div><br/></div><div><b>删除文档</b></div><div>db.blog.remove() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除集合内所有文档 </div><div>db.blog.remove({"title" : "aa"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除集合中指定文档 </div><div>全部删除集合内大量文档时可采用db.blog.drop()，然后再重建集合和索引</div><div><br/></div><div><br/></div><div><b>更新文档</b></div><div><i>完全替换文档</i></div><div>var joe = db.users.findOne({"name" : "joe"});</div><div>joe.relationships = {"friends" : joe.friends, "enemies" :&nbsp;&nbsp;joe.enemies};</div><div>joe.username = joe.name;</div><div>delete joe.friends;</div><div>delete joe.enemies;</div><div>delete joe.name;</div><div>db.users.update({"name" : "joe"}, joe);</div><div><br/></div><div>db.users.update({"_id" : ObjectId("4d2b9f67...")}, joe); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;指定文档Id更新 </div><div><br/></div><div><br/></div><div><i>使用修改器</i></div><div>db.users.update({"name" : "joe"}, {"$inc" : {"friends" : 5}}) &nbsp;&nbsp; 使用修改器$inc使人数加5，字段不存在则创建</div><div><br/></div><div>{"$set" : {"book" : "a"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;修改一个字段的值，字段不存在则创建 </div><div>{"$set" : {"relationships.enemies" : "b"}} &nbsp;&nbsp;&nbsp;&nbsp;修改内嵌文档relationships下的enemies字段 </div><div>{"$unset" : {"book" : 1}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除文档的字段 </div><div><br/></div><div>{"$push" : {"comments" : "a"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 数组内追加一个值，字段不存在则创建 </div><div>{"$push" : {"comments" : {"$each" : ["a", "b"]}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数组内追加多个值 </div><div>{"$push" : {"comments" : {"$each" : ["a", "b"], "$slice" : -10}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数组内只包含最后追加的10个值 </div><div>{"$push" : {"comments" : {"$each" : [{"name" : "a"}], "$slice" : -10, "$sort" : {"name" : -1}}}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对数组的name字段先排序，再保留前10个 </div><div>db.users.update({"names" : {"$ne" : "a"}},&nbsp;&nbsp;{"$push" : {"names" : "a"}}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [a]不在数组中才追加 </div><div>db.users.update({"_id" : ObjectId("...")}, {"$addToSet" : {"emails" : "joe@..."}})&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[joe@...]不在数组中才追加，可以和$each结合使用 </div><div><br/></div><div>{"$pop" :&nbsp;&nbsp;{"key" : 1} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 从数组末尾删除 </div><div>{"$pop" :&nbsp;&nbsp;{"key" : -1} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从数组头部删除 </div><div>db.users.update({},&nbsp;&nbsp;{"$pull" :&nbsp;&nbsp;{"todo" : "laundry"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除数组中匹配内容 </div><div><br/></div><div>comments.0.votes &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使用数组下标选择并操作数组 </div><div>db.users.update({"comments.auther" : "John"}, {"$set" :&nbsp;&nbsp;{"comments.$.auther" : "Jim"}}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;定位符$，只定位第一个匹配的下标 </div><div><br/></div><div>文档增大，磁盘连续位置大小不够时会被移动到集合末尾；数据库自动管理填充因子（paddingFactor）对文档保留连续磁盘空间；太多空白空间需要进行压缩，以免影响查询速度</div><div>db.runCommand({"collMod" : blog, "usePowerOf2Sizes" : true}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;修改指定集合usePowerOf2Sizes属性，增加预留分配空间，对经常改变文档大小的集合使用 </div><div><br/></div><div><br/></div><div><i>upsert</i></div><div>文档存在更新，不存在创建</div><div>db.users.update({"name" : "a"}, {"$inc" : {"pageviews" : 1}}, true) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true表示使用upsert </div><div>db.users.update({}, {"$setOneInsert" :&nbsp;&nbsp;{"create" : new Date()}, true} &nbsp;&nbsp;&nbsp;&nbsp;创建并赋值，保证只创建一次 </div><div><br/></div><div>var x = db.users.findOne() &nbsp;&nbsp; db.users.save(x) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; save是shell函数，存在更新，不存在创建 </div><div><br/></div><div><br/></div><div><i>更新多个文档</i></div><div>默认update只对匹配条件的第一个文档执行操作（不同软件版本行为可能发生变化）</div><div>db.users.update({}, {}, false, true) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第四个参数为true则可匹配所有文档，false只匹配一个 </div><div><br/></div><div>db.runCommand({getLastError : 1}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 查看最后一次操作信息 </div><div><br/></div><div><br/></div><div><i>返回被更新的文档</i></div><div>ps = db.runCommand({"findAndModify" : "users", "query" : {"status" : "READY"}, "sort" : {"priority" : -1}, "update" : {"$set" : {"status" : "RUNNING"}}}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 返回被更新之前的文档 </div><div><br/></div><div>findAndModify命令</div><div>findAndModify &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;集合名 </div><div>query &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;检索条件 </div><div>sort &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 排序条件 </div><div>update &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 修改文档 </div><div>remove &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 删除文档，值为布尔型 </div><div>new &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;返回更新前还是更新后文档，值为布尔型，默认更新前 </div><div>fields &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 文档中需要返回的字段 </div><div>upsert &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 更新插入，值为布尔型 </div><div><br/></div><div><br/></div><div><b>写入安全机制</b></div><div>应答式写入：默认机制，数据库给出操作是否成功响应</div><div>非<span style="color: rgb(0, 0, 0); font-family: 宋体; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: medium; display: inline !important; float: none;">应答式写入：不返回任何响应</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></div></body></html>