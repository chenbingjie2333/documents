<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="created" content="2016-01-25 07:40:24 +0000"/><meta name="updated" content="2016-11-24 08:58:13 +0000"/><title>第二十二章：备份</title></head><body><div><b>对服务器进行备份</b></div><div>生成文件系统快照，系统本身支持快照，必须开启日记系统</div><div><br/></div><div>复制数据文件</div><div>db.fsyncLock()                锁定所有数据库，禁止任何写入并进行同步</div><div>db.fsynUnlock()               解除锁定，启动身份验证时不能中途断开shell</div><div><br/></div><div>使用mongodump</div><div>mongodump --help              查看mongodump帮助</div><div>mongodump -p 31000            备份端口是31000的数据库</div><div>mongodump --dbpath /data/db   对数据文件进行备份（数据库停止时使用）</div><div>--oplog                       备份时记录操作，保证同步在一个时间点上</div><div>指定副本集的连接字符，备份副本</div><div>mongorestore -p 31000 --oplogReplay dump/      恢复数据库，可指定--version防止版本不同出错</div><div>mongorestore --db newDb --collection someOtherColl dump/oldDB/oldColl.bson       改变数据库或集合名称</div><div>唯一索引采用mongodump备份可能出现问题</div><div><br/></div><div><br/></div><div><b>对副本集备份</b></div><div>使用mongodump时必须处理oplog</div><div><br/></div><div><br/></div><div><b>对分片集合进行备份</b></div><div>应先关闭均衡器，通过mongos运行mongodump，恢复时也要通过mongos</div><div><br/></div><div><br/></div><div><b>使用mongooplog进行增量备份</b></div><div>op = db.oplog.rs.find().sort({$natural : -1}).limit(1).net()</div><div>start = op['ts']['t']/1000         取得最后操作时间</div><div>备份服务器A的全部数据</div><div>在服务器B上执行</div><div>mongooplog --from A --seconds 123456      备份oplog，seconds为最后操作时间和当前时间的差值</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>