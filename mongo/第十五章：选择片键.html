<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454269)"/><meta name="author" content="lcx3114@163.com"/><meta name="created" content="2016-01-18 13:29:09 +0000"/><meta name="updated" content="2016-01-19 12:48:33 +0000"/><title>第十五章：选择片键</title></head><body><div><b>数据分发</b></div><div>升序片键</div><div>随机分发的片键</div><div>sh.addShardTag("shard00", "USPS") &nbsp;&nbsp;&nbsp;&nbsp;sh.addTagRang("test.ips", {"ip" : "056.000.000.000"}, {"ip" : "057.000.000.000"}, "USPS") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于位置的片键 </div><div><br/></div><div><br/></div><div><b>片键策略</b></div><div>db.users.ensureIndex({"username" : "hashed"}) &nbsp;&nbsp;&nbsp;&nbsp;sh.shardCollection("app.users", {"username" : "hashed"}) &nbsp;&nbsp;&nbsp;&nbsp;散列片键 </div><div>db.fs.chunks.ensureIndex({"files_id" : "hashed"}) &nbsp;&nbsp;&nbsp;&nbsp;sh.shardCollection("test.fs.chunks", {"files_id" : "hashed"}) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridFS散列片键 </div><div><br/></div><div>sh.addShardTag("shard-name", "ssd") &nbsp;&nbsp;&nbsp;&nbsp;sh.addTagRang("dbName.collName", {"_id" : ObjectId()}, {"_id" : MaxKey}, "ssd") &nbsp;&nbsp; 每天定时任务内追加【use config &nbsp;&nbsp;&nbsp;&nbsp;var tag = db.tags.findOne({"ns" : "dbName.collName", "max" : {"shardKey" : MaxKey}}) &nbsp;&nbsp;&nbsp;&nbsp;tag.min.shardKey = ObjectId() &nbsp;&nbsp;&nbsp;&nbsp;db.tags.save(tag)】 &nbsp;&nbsp;&nbsp;&nbsp; 流水策略，将数据先保存到处理速度很快的服务器，然后再使用均衡器分发 </div><div><br/></div><div>多热点</div><div><br/></div><div><br/></div><div><b>片键规则和指导方针</b></div><div>片键限制：不可以是数组、文档一旦插入片键值不能修改</div><div><br/></div><div><br/></div><div><b>控制数据分发</b></div><div>sh.removeShardTag("shard00", "USPS") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除标签 </div><div>mongos的config.tags命名空间保存标签范围，config.shards保存标签信息</div><div><br/></div><div>mongos内db.settings.update({"_id" : "balancer"}, {"enabled" : false}, true) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关闭均衡器 </div><div>sh.moveChunk("test.manual.stuff", {"user_id" : NumberLong("-123132")}, "test-rs1") &nbsp;&nbsp;&nbsp;&nbsp; 手动迁移块到其它分片 </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>